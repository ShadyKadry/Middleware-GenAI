<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Middleware for GenAI</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="layout">

    <!-- Sidebar -->
    <aside id="showSidebar" class="sidebar hidden">
      <h2>Welcome, {{ user }}! </h2>
      <h3>Role: {{ role }} </h3>
      <div class="sidebar-actions">
        <button id="logoutBtn">Log out</button>
      </div>

      <hr class="sidebar-divider" />

      <h3>You can:</h3>
      <div id="sidebar-actions" >
        <button type="button" class="admin-only" data-target="panelDataUpload">Upload documents</button>
        <button type="button" class="admin-only" data-target="panelUserCreation">Create user</button>
        <button type="button" class="admin-only" data-target="panelServerRegistration">Add MCP servers</button>
        <button type="button" data-target="panelAutoSearch,panelChat,panelTools">Chat</button>
      </div>

    </aside>

    <!-- Main content -->
    <main class="main">

      <!-- Show credentials of logged-in user. -->
      <div id="panelWelcome" class="card panel">
        <p>You are logged in.</p>
        <pre id="meBox"></pre>
      </div>

      <!--- ADMIN only: Upload data. --->
      <div id="panelDataUpload" class="card panel hidden">
        <h2>Upload documents.</h2>

        <form id="uploadForm">
          <label for="uploadCorpusId">Corpus ID:</label>
          <input id="uploadCorpusId" name="corpus_id" type="text" placeholder="Identifier which is used to store/retrieve the document..." required />

          <label for="uploadUserId">Allowed User ID's (optional):</label>
          <input id="uploadUserId" name="user_id" type="text" placeholder="Please state the user's which are allowed to see this document... (seperated by ;)" />

          <!-- Allowed Roles (optional) -->
          <div class="form-group" style="margin-top: 16px;"> <!-- TODO move to css -->
            <label for="uploadAllowedRoles">Allowed Roles (optional):</label>

            <div id="uploadAllowedRoles" style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 8px;"> <!-- TODO move to css -->
              <!-- Example roles - adjust to your system -->
              <label><input type="checkbox" name="allowed_roles" value="User" /> User</label>
              <label><input type="checkbox" name="allowed_roles" value="Student" /> Student</label>
              <label><input type="checkbox" name="allowed_roles" value="Guest" /> Guest</label>
            </div>
          </div>

          <label for="uploadEmbeddingModel">Embedding Model:</label>
          <select id="uploadEmbeddingModel" name="embedding_model"></select>

          <div class="upload-row">
            <div class="field">
              <label for="uploadChunkSize">Chunk Size:</label>
              <input id="uploadChunkSize" name="chunk_size" type="number" value="1200" min="100" />
            </div>

            <div class="field">
              <label for="uploadChunkOverlap">Chunk Overlap:</label>
              <input id="uploadChunkOverlap" name="chunk_overlap" type="number" value="200" min="0" />
            </div>

            <div class="field">
              <label for="uploadFile">File (.txt, .pdf, .pptx, .docx, .md, ...)</label>
              <input id="uploadFile" name="file" type="file" accept="..." required />
            </div>
          </div>

          <button type="submit" id="uploadBtn">Upload</button>
        </form>

        <div id="uploadStatus" class="upload-status"></div>
      </div>


      <!-- ADMIN only: Create user. -->
      <div id="panelUserCreation" class="card panel hidden">
        <h2>Create new user.</h2>

        <form id="createUserForm">
          <input id="cuUsername" placeholder="Username" required />

          <input id="cuPassword"
                 type="password"
                 placeholder="Password"
                 required />

          <div class="inline-field">
            <label for="cuRole">Role:</label>
            <select id="cuRole">
              <option value="Guest">Guest</option>
              <option value="User">User</option>
              <option value="Admin">Admin</option>
              <option value="Student">Student</option>
            </select>
          </div>

          <fieldset class="card" style="margin-top:12px;">
            <legend>Select MCP Servers</legend>
            <div id="cuToolsList" class="cutools-list"></div>
            <input type="hidden" id="cuTools" name="cutools" value="[]" />
          </fieldset>

          <fieldset class="card" style="margin-top:12px;">
            <legend>Select Document Collections</legend>
            <div id="cuCorporaList" class="cucorpora_list"></div>
            <input type="hidden" id="cuCorpora" name="cuCorpora" value="[]" />
          </fieldset>

          <button type="submit">Create</button>
        </form>

        <div id="createUserMsg"></div>
      </div>

      <!-- ADMIN only: Register new servers. -->
      <div id="panelServerRegistration" class="card panel hidden">
        <h2>Register new MCP servers.</h2>

        <form id="registerNewMCPServer">
          <button type="submit">Register</button>
        </form>
      </div>


      <!--- Display auto pre-search.--->
      <div id="panelAutoSearch" class="card panel">
        <h2>Chat.</h2>
        <label class="chat-autosearch-toggle">
          <input id="autoSearchToggle" type="checkbox" /> Auto pre-search
        </label>

        <div id="chat-autosearch-form" >
          <div>
            <div class="chat-autosearch-field is-string">
              <div id="asCheckboxesStatus" class="muted">Loadingâ€¦</div>

              <div id="asCorporaContainer" style="display:none;">
                <div class="corpora-grid">
                  <fieldset class="card" style="margin-top:12px;">
                    <legend>Select document collections</legend>
                    <div id="asCorporaList" class="ascorpora-list"></div>
                    <input type="hidden" id="asCorpora" name="asCorpora" value="[]" />
                  </fieldset>

                                    <!-- RIGHT: controls -->
                  <div class="corpora-right">
                    <div class="corpus-controls">
                      <button id="corpusAllBtn" type="button">Select all</button>
                      <button id="corpusNoneBtn" type="button">Select none</button>
                    </div>

                    <div class="topk-control">
                      <label for="chatSearchK">Top K:</label>
                      <input id="chatSearchK" name="chat_search_k" type="number" value="5" min="1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat interface. -->
      <div id="panelChat" class="card panel">

        <div id="chatLog" style="white-space: pre-wrap; margin-bottom: 12px;"></div>

        <form id="chatForm">
          <input id="chatInput" name="message" placeholder="Type a message..." required />
          <button type="submit">Send</button>
        </form>

        <div id="chatErr" class="err"></div>
      </div>

      <!--- Display available tools.--->
      <div id="panelTools" class="card panel">
        <h3>Available Tools</h3>

        <div class="tools-bar">
          <div id="toolsStatus">Loading...</div>
          <div class="tools-actions">
            <button type="button" id="toolsSelectAllBtn">Select all</button>
            <button type="button" id="toolsSelectNoneBtn">Select none</button>
          </div>
        </div>

        <div class="tools-sub">
          Enabled: <span id="toolsEnabledCount">0</span>
        </div>

        <ul id="toolsList" class="tools-list"></ul>
      </div>


      <!-- Markdown parser -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

      <!-- Sanitizer (recommended for safety) -->
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

      <!-- Application -->
      <script src="/static/app.js"></script>
    </main>
  </div>
</body>
</html>
