<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Middleware for GenAI</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="layout">

    <!-- Sidebar -->
    <aside id="showSidebar" class="sidebar hidden">
      <h2>Welcome, <span id="sidebarUser">{{ user }}</span>!</h2>
      <div id="sidebarRole" class="sidebar-role"></div>
      <div class="sidebar-actions">
        <button id="logoutBtn">Log out</button>
      </div>

      <hr class="sidebar-divider" />

      <h3>You can:</h3>
      <div id="sidebar-actions" >
        <button type="button" class="admin-only" data-target="panelDataUpload">Upload documents</button>
        <button type="button" class="admin-only" data-target="panelUserCreation">Create user</button>
        <button type="button" class="admin-only" data-target="panelServerRegistration">Add MCP servers</button>
        <button type="button" data-target="panelAutoSearch,panelChat,panelTools">Chat</button>
      </div>

    </aside>

    <!-- Main content -->
    <main class="main">

      <!-- Show credentials of logged-in user. -->
      <div id="panelWelcome" class="card panel">
        <p>You are logged in.</p>
        <pre id="meBox"></pre>
      </div>

      <!--- ADMIN only: Upload data. --->
      <div id="panelDataUpload" class="card panel hidden">
        <h2>Upload documents.</h2>

        <form id="uploadForm">
          <label for="uploadCorpusId">Corpus ID:</label>
          <input id="uploadCorpusId" name="corpus_id" type="text" placeholder="Identifier which is used to store/retrieve the document..." required />

          <label for="uploadUserId">Allowed User ID's (optional):</label>
          <input id="uploadUserId" name="user_id" type="text" placeholder="Please state the user's which are allowed to see this document... (seperated by ;)" />

          <label for="uploadEmbeddingModel">Embedding Model:</label>
          <select id="uploadEmbeddingModel" name="embedding_model"></select>

          <div class="upload-row">
            <div class="field">
              <label for="uploadChunkSize">Chunk Size:</label>
              <input id="uploadChunkSize" name="chunk_size" type="number" value="1200" min="100" />
            </div>

            <div class="field">
              <label for="uploadChunkOverlap">Chunk Overlap:</label>
              <input id="uploadChunkOverlap" name="chunk_overlap" type="number" value="200" min="0" />
            </div>

            <div class="field">
              <label for="uploadFile">File (.txt, .pdf, .pptx, .docx, .md, ...)</label>
              <input id="uploadFile" name="file" type="file" accept="..." required />
            </div>
          </div>

          <button type="submit" id="uploadBtn">Upload</button>
        </form>

        <div id="uploadStatus" class="upload-status"></div>
      </div>


      <!-- ADMIN only: Create user. -->
      <div id="panelUserCreation" class="card panel hidden">
        <h2>Create new user.</h2>

        <form id="createUserForm">
          <input id="cuUsername" placeholder="Username" required />

          <input id="cuPassword"
                 type="password"
                 placeholder="Password"
                 required />

          <div class="inline-field">
            <label for="cuRole">Role:</label>
            <select id="cuRole">
              <option value="Guest">Guest</option>
              <option value="User">User</option>
              <option value="Admin">Admin</option>
              <option value="Student">Student</option>
            </select>
          </div>

          <fieldset class="card" style="margin-top:12px;">
            <legend>Tools</legend>
            <div id="cuToolsList" class="cutools-list"></div>
            <input type="hidden" id="cuTools" name="cutools" value="[]" />
          </fieldset>

          <button type="submit">Create</button>
        </form>

        <div id="createUserMsg"></div>
      </div>

      <!-- ADMIN only: Register new servers. -->
      <div id="panelServerRegistration" class="card panel hidden">
        <h2>Register new MCP servers.</h2>

        <form id="registerNewMCPServer">
          <label for="mcpName">Name:</label>
          <input id="mcpName" name="name" type="text" placeholder="unique server name" required />

          <label for="mcpTransport">Transport:</label>
          <select id="mcpTransport" name="transport">
            <option value="stdio">docker (stdio)</option>
            <option value="sse">sse</option>
            <option value="http">http</option>
          </select>

          <div id="mcpStdioFields" class="mcp-transport-fields">
            <div class="field">
              <label for="mcpCommand">Command (stdio):</label>
              <input id="mcpCommand" name="command" type="text" placeholder="docker" />
            </div>

            <div class="field">
              <label for="mcpArgs">Args (one per line):</label>
              <textarea id="mcpArgs" name="args" rows="3" placeholder="run&#10;-i&#10;--rm&#10;mcp/your-server"></textarea>
            </div>
          </div>

          <div id="mcpRemoteFields" class="mcp-transport-fields hidden">
            <div class="field">
              <label for="mcpServerUrl">Server URL (sse/http):</label>
              <input id="mcpServerUrl" name="server_url" type="text" placeholder="https://example.com/sse" />
            </div>

            <div class="field">
              <label for="mcpHeaders">Headers (optional, key: value per line or JSON):</label>
              <textarea id="mcpHeaders" name="headers" rows="3" placeholder="Authorization: Bearer xyz"></textarea>
            </div>
          </div>

          <label for="mcpAllowedUsers">Allowed users (optional, ; separated):</label>
          <input id="mcpAllowedUsers" name="allowed_users" type="text" placeholder="user;test_user_1" />

          <label for="mcpRequiredRoles">Required roles (optional, ; separated):</label>
          <input id="mcpRequiredRoles" name="required_roles" type="text" placeholder="admin;user" />

          <label class="inline-field">
            <input id="mcpEnabled" name="enabled" type="checkbox" checked />
            Enabled
          </label>

          <button type="submit">Register</button>
        </form>
        <div id="mcpRegisterStatus" class="upload-status"></div>
      </div>


      <!--- Display auto pre-search.--->
      <div id="panelAutoSearch" class="card panel">
        <h2>Chat.</h2>
        <label class="chat-autosearch-toggle">
          <input id="autoSearchToggle" type="checkbox" /> Auto pre-search
        </label>

        <div id="chat-autosearch-form" >
          <div>
            <div class="chat-autosearch-field is-string">
              <label for="chatCorpusId">Corpus ID's:</label>
              <input id="chatCorpusId" name="chat_corpus_id" type="text" placeholder="Please state the ID's which should be searched... (seperated by ;)"/>
            </div>
          </div>

          <div class="chat-autosearch-row">
            <div class="chat-autosearch-field is-select">
              <label for="chatEmbeddingModel">Embedding model:</label>
              <select id="chatEmbeddingModel" name="chat_embedding_model"></select>
            </div>

            <div class="chat-autosearch-field">
              <label for="chatSearchK">Top K:</label>
              <input id="chatSearchK" name="chat_search_k" type="number" value="5" min="1" />
            </div>
          </div>
        </div>
      </div>


      <!-- Chat interface. -->
      <div id="panelChat" class="card panel">

        <div id="chatLog" class="chat-log"></div>

        <form id="chatForm">
          <input id="chatInput" name="message" placeholder="Type a message..." required />
          <button type="submit">Send</button>
        </form>

        <div id="chatErr" class="err"></div>
      </div>

      <!--- Display available tools.--->
      <div id="panelTools" class="card panel">
        <h3>Available Tools</h3>

        <div class="tools-bar">
          <div id="toolsStatus">Loading...</div>
          <div class="tools-actions">
            <button type="button" id="toolsSelectAllBtn">Select all</button>
            <button type="button" id="toolsSelectNoneBtn">Select none</button>
          </div>
        </div>

        <div class="tools-sub">
          Enabled: <span id="toolsEnabledCount">0</span>
        </div>

        <ul id="toolsList" class="tools-list"></ul>
      </div>


      <!-- Markdown parser -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

      <!-- Sanitizer (recommended for safety) -->
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

      <!-- Application -->
      <script src="/static/app.js"></script>
    </main>
  </div>
</body>
</html>
